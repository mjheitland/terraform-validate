name: terraform-validate
description: |
  Pipeline for Terraform Modules to validate the module. This action is usually
  run on Pull Request creation and updates.

inputs:
  working-directory:
    description: Directory containing the Terraform module code. (default = ".")
    default: '.'
    required: false
  go-version:
    description: Go version used for running the terratest tests.
    default: "1.18"
    required: false
  environment:
    description: Environment to deploy to. (default = dev)
    default: dev
    required: false

runs:
  using: composite

  steps:
    - name: checkout
      uses: actions/checkout@v3
      with:
        persist-credentials: false
        ref: ${{ github.event.pull_request.head.sha }}

    - name: setup
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_wrapper: false

    - name: format
      id: fmt
      shell: bash
      continue-on-error: true
      run: terraform -chdir="${{ inputs.working-directory }}" fmt -recursive -check

    - name: init
      id: init
      shell: bash
      run: terraform -chdir="${{ inputs.working-directory }}" init -upgrade

    - name: validate
      id: validate
      continue-on-error: true
      shell: bash
      run: terraform -chdir="${{ inputs.working-directory }}" validate -no-color

    - name: cache
      uses: actions/cache@v3
      with:
        path: ~/.tflint.d/plugins
        key: tflint-${{ hashFiles('.tflint.hcl') }}

    - name: tflint-setup
      uses: terraform-linters/setup-tflint@v2
      with:
        github_token: ${{ github.token }}

    - name: setup-golang
      uses: actions/setup-go@v3
      with:
        go-version: ${{ inputs.go-version }}

    - name: tflint-setup-plugins
      shell: bash
      run: |
          go version
          GOBIN="${PWD}/.bin"
          mkdir -p "${GOBIN}"
          GOBIN="${GOBIN}" go install github.com/terraform-linters/tflint-ruleset-aws@latest
          GOBIN="${GOBIN}" go install github.com/terraform-linters/tflint-ruleset-google@latest
          GOBIN="${GOBIN}" go install github.com/terraform-linters/tflint-ruleset-azurerm@latest
          mkdir -p ~/.tflint.d/plugins
          cp -f "${GOBIN}/tflint-ruleset-aws" ~/.tflint.d/plugins
          cp -f "${GOBIN}/tflint-ruleset-google" ~/.tflint.d/plugins
          cp -f "${GOBIN}/tflint-ruleset-azurerm" ~/.tflint.d/plugins

    - name: tflint
      id: tflint
      continue-on-error: true
      shell: bash
      run: |
        tflint --version
        tflint --format=compact "${{ inputs.working-directory }}"
        tflint --format=sarif "${{ inputs.working-directory }}" >${{ inputs.working-directory}}/tflint.sarif

    # - name: post-tflint-results
    #   continue-on-error: true
    #   uses: github/codeql-action/upload-sarif@v2
    #   with:
    #     sarif_file: ${{ inputs.working-directory}}/tflint.sarif
    #     category: tflint

    - name: tfsec
      id: tfsec
      continue-on-error: true
      uses: aquasecurity/tfsec-sarif-action@v0.1.3
      with:
        working-directory: ${{  inputs.working-directory }}
        sarif_file: tfsec.sarif

    - name: post-tfsec-comments
      uses: aquasecurity/tfsec-pr-commenter-action@v1.2.0
      if: github.event.name == 'pull_request'
      with:
        github_token: ${{ github.token }}
        working-directory: terraform

    # - name: post-tfsec-results
    #   continue-on-error: true
    #   uses: github/codeql-action/upload-sarif@v2
    #   with:
    #     sarif_file: terraform/tfsec.sarif
    #     category: tfsec

    # - name: change-directory
    #   shell: bash
    #   run: cd "${{ inputs.working-directory }}"

    # - name: go-get
    #   shell: bash
    #   run: |
    #       go version
    #       go get ./...
    #       go mod tidy

    # - name: assume-apply-role
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     role-to-assume: arn:aws:iam::804313491716:role/ops/blueprints-apply
    #     aws-region: us-east-1

    # - name: setup
    #   shell: bash
    #   run: |
    #       terraform -chdir=test/setup init -upgrade
    #       terraform -chdir=test/setup apply -auto-approve -input=false || true

    # - name: test
    #   id: terratest
    #   continue-on-error: true
    #   shell: bash
    #   run: |
    #       go test -v ./test/integration

    # - name: teardown
    #   shell: bash
    #   run: terraform -chdir=test/setup apply -destroy -auto-approve -input=false

    # - name: cleanup
    #   shell: bash
    #   run: git checkout . && git status

    # - name: checkout
    #   uses: actions/checkout@v3
    #   with:
    #     persist-credentials: true
    #     ref: ${{ github.event.pull_request.head.sha }}

    # - name: terraform-docs
    #   id: terraform-docs
    #   continue-on-error: true
    #   uses: terraform-docs/gh-actions@v1
    #   with:
    #     config-file: .terraform-docs.yaml
    #     output-format: markdown document
    #     recursive: true

    #     git-push: true
    #     git-push-user-email: terraform-docs-bot@spglobal.com
    #     git-push-user-name: terraform-docs[bot]
    #     git-push-sign-off: true
    #     git-commit-message: "chore: add terraform docs"

    # - name: exit-on-error
    #   shell: bash
    #   if: |
    #     steps.fmt.outcome == 'failure' ||
    #     steps.validate.outcome == 'failure' ||
    #     steps.tflint.outcome == 'failure' ||
    #     steps.tfsec.outcome == 'failure' ||
    #     steps.terratest.outcome == 'failure' ||
    #     steps.terraform-docs.outcome == 'failure'
    #   run: exit 1
